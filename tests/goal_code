/////////
// ALGO

// step 1: LOCK
goal app call --from=$A --app-id=$STATE --app-arg="str:LOCK" --app-arg="addr:$B" --app-arg="int:$SPEED" --out=$TXNS_DIR/state.txn -w $WALLET
goal clerk send --from=$A --to=$ESCROW --amount=$(($LOCK_ALGO_FEE+$ENERGY)) --out=$TXNS_DIR/lock.txn -w $WALLET
cat $TXNS_DIR/state.txn $TXNS_DIR/lock.txn > $TXNS_DIR/combinedtransactions.txn
goal clerk group --infile $TXNS_DIR/combinedtransactions.txn --outfile $TXNS_DIR/groupedtransactions.txn
goal clerk sign --infile $TXNS_DIR/groupedtransactions.txn --outfile $TXNS_DIR/signout.txn -w $WALLET
goal clerk rawsend --filename $TXNS_DIR/signout.txn

// step 2: UNLOCK
goal app call --from=$OWNER --app-id=$STATE --app-account=$A --app-account=$B --app-arg="str:UNLOCK" --app-arg="int:$DURATION" --out=$TXNS_DIR/state.txn -w $WALLET
goal clerk send --from-program $ESCROW_FILE --to=$FEE --amount=$(($UNLOCK_FEE+$ENERGY_FEE)) --out=$TXNS_DIR/fee.txn
goal clerk send --from-program $ESCROW_FILE --to=$B --amount=$ENERGY_B --out=$TXNS_DIR/B.txn
goal clerk send --from-program $ESCROW_FILE --to=$A --amount=$ENERGY_A --out=$TXNS_DIR/A.txn
cat $TXNS_DIR/state.txn $TXNS_DIR/fee.txn $TXNS_DIR/B.txn $TXNS_DIR/A.txn > $TXNS_DIR/combinedtransactions.txn
goal clerk group --infile $TXNS_DIR/combinedtransactions.txn --outfile $TXNS_DIR/groupedtransactions.txn
goal clerk split --infile $TXNS_DIR/groupedtransactions.txn --outfile $TXNS_DIR/splitfiles
goal clerk sign --infile $TXNS_DIR/splitfiles-0 --outfile $TXNS_DIR/splitfiles-0.sig -w $WALLET
cat $TXNS_DIR/splitfiles-0.sig $TXNS_DIR/splitfiles-1 $TXNS_DIR/splitfiles-2 $TXNS_DIR/splitfiles-3 > $TXNS_DIR/signout.txn
goal clerk rawsend --filename $TXNS_DIR/signout.txn

// step 2B: UNLOCK + A gets nothing
goal app call --from=$OWNER --app-id=$STATE --app-account=$A --app-account=$B --app-arg="str:UNLOCK" --out=$TXNS_DIR/state.txn -w $WALLET
goal clerk send --from-program $ESCROW_FILE --to=$FEE --amount=$(($UNLOCK_FEE+$ENERGY_FEE)) --out=$TXNS_DIR/fee.txn
goal clerk send --from-program $ESCROW_FILE --to=$B --amount=$ENERGY_B --out=$TXNS_DIR/B.txn
cat $TXNS_DIR/state.txn $TXNS_DIR/fee.txn $TXNS_DIR/B.txn > $TXNS_DIR/combinedtransactions.txn
goal clerk group --infile $TXNS_DIR/combinedtransactions.txn --outfile $TXNS_DIR/groupedtransactions.txn
goal clerk split --infile $TXNS_DIR/groupedtransactions.txn --outfile $TXNS_DIR/splitfiles
goal clerk sign --infile $TXNS_DIR/splitfiles-0 --outfile $TXNS_DIR/splitfiles-0.sig -w $WALLET
cat $TXNS_DIR/splitfiles-0.sig $TXNS_DIR/splitfiles-1 $TXNS_DIR/splitfiles-2 > $TXNS_DIR/signout.txn
goal clerk rawsend --filename $TXNS_DIR/signout.txn

/////////





/////////
// ASA


// step 1: LOCK - A does this
goal app call --from=$A --app-id=$STATE --app-arg="str:LOCK" --app-arg="addr:$B" --app-arg="int:$SPEED" --out=$TXNS_DIR/state.txn -w $WALLET
goal clerk send --from=$A --to=$ESCROW --amount=$LOCK_ASA_FEE --out=$TXNS_DIR/lock_algo.txn -w $WALLET
goal asset send --assetid=$ASA --from=$A --to=$ESCROW --amount=$ENERGY --out=$TXNS_DIR/lock_asa.txn -w $WALLET
cat $TXNS_DIR/state.txn $TXNS_DIR/lock_algo.txn $TXNS_DIR/lock_asa.txn > $TXNS_DIR/combinedtransactions.txn
goal clerk group --infile $TXNS_DIR/combinedtransactions.txn --outfile $TXNS_DIR/groupedtransactions.txn
goal clerk sign --infile $TXNS_DIR/groupedtransactions.txn --outfile $TXNS_DIR/signout.txn -w $WALLET
goal clerk rawsend --filename $TXNS_DIR/signout.txn

// step 2: UNLOCK
goal app call --from=$OWNER --app-id=$STATE --app-account=$A --app-account=$B --app-arg="str:UNLOCK" --app-arg="int:$DURATION" --out=$TXNS_DIR/state.txn -w $WALLET
goal clerk send --from-program $ESCROW_FILE --to=$FEE --amount=$UNLOCK_FEE --out=$TXNS_DIR/fee_algo.txn
goal asset send --from $ESCROW --to=$FEE --assetid=$ASA --amount=$ENERGY_FEE --out=$TXNS_DIR/fee_asa.txn
goal asset send --from $ESCROW --to=$B --assetid=$ASA --amount=$ENERGY_B --out=$TXNS_DIR/B.txn
goal asset send --from $ESCROW --to=$A --assetid=$ASA --amount=$ENERGY_A --out=$TXNS_DIR/A.txn
cat $TXNS_DIR/state.txn $TXNS_DIR/fee_algo.txn $TXNS_DIR/fee_asa.txn $TXNS_DIR/B.txn $TXNS_DIR/A.txn > $TXNS_DIR/combinedtransactions.txn
goal clerk group --infile $TXNS_DIR/combinedtransactions.txn --outfile $TXNS_DIR/groupedtransactions.txn
goal clerk split --infile $TXNS_DIR/groupedtransactions.txn --outfile $TXNS_DIR/splitfiles
goal clerk sign --infile $TXNS_DIR/splitfiles-0 --outfile $TXNS_DIR/splitfiles-0.sig -w $WALLET
goal clerk sign --infile $TXNS_DIR/splitfiles-1 --outfile $TXNS_DIR/splitfiles-1.sig --program $ESCROW_FILE
goal clerk sign --infile $TXNS_DIR/splitfiles-2 --outfile $TXNS_DIR/splitfiles-2.sig --program $ESCROW_FILE
goal clerk sign --infile $TXNS_DIR/splitfiles-3 --outfile $TXNS_DIR/splitfiles-3.sig --program $ESCROW_FILE
goal clerk sign --infile $TXNS_DIR/splitfiles-4 --outfile $TXNS_DIR/splitfiles-4.sig --program $ESCROW_FILE
cat $TXNS_DIR/splitfiles-0.sig $TXNS_DIR/splitfiles-1.sig $TXNS_DIR/splitfiles-2.sig $TXNS_DIR/splitfiles-3.sig $TXNS_DIR/splitfiles-4.sig > $TXNS_DIR/signout.txn
goal clerk rawsend --filename $TXNS_DIR/signout.txn

// step 2B: UNLOCK + A gets nothing
goal app call --from=$OWNER --app-id=$STATE --app-account=$A --app-account=$B --app-arg="str:UNLOCK" --out=$TXNS_DIR/state.txn -w $WALLET
goal clerk send --from-program $ESCROW_FILE --to=$FEE --amount=$UNLOCK_FEE --out=$TXNS_DIR/fee_algo.txn
goal asset send --from $ESCROW --to=$FEE --assetid=$ASA --amount=$ENERGY_FEE --out=$TXNS_DIR/fee_asa.txn
goal asset send --from $ESCROW --to=$B --assetid=$ASA --amount=$ENERGY_B --out=$TXNS_DIR/B.txn
cat $TXNS_DIR/state.txn $TXNS_DIR/fee_algo.txn $TXNS_DIR/fee_asa.txn $TXNS_DIR/B.txn > $TXNS_DIR/combinedtransactions.txn
goal clerk group --infile $TXNS_DIR/combinedtransactions.txn --outfile $TXNS_DIR/groupedtransactions.txn
goal clerk split --infile $TXNS_DIR/groupedtransactions.txn --outfile $TXNS_DIR/splitfiles
goal clerk sign --infile $TXNS_DIR/splitfiles-0 --outfile $TXNS_DIR/splitfiles-0.sig -w $WALLET
goal clerk sign --infile $TXNS_DIR/splitfiles-1 --outfile $TXNS_DIR/splitfiles-1.sig --program $ESCROW_FILE
goal clerk sign --infile $TXNS_DIR/splitfiles-2 --outfile $TXNS_DIR/splitfiles-2.sig --program $ESCROW_FILE
goal clerk sign --infile $TXNS_DIR/splitfiles-3 --outfile $TXNS_DIR/splitfiles-3.sig --program $ESCROW_FILE
cat $TXNS_DIR/splitfiles-0.sig $TXNS_DIR/splitfiles-1.sig $TXNS_DIR/splitfiles-2.sig $TXNS_DIR/splitfiles-3.sig > $TXNS_DIR/signout.txn
goal clerk rawsend --filename $TXNS_DIR/signout.txn

/////////

/////////
// Should fail
goal asset send -a 3 --assetid $ASA -f $OWNER -t $ESCROW -w $WALLET
goal asset send --from $ESCROW --to=$OWNER --assetid=$ASA --amount=3 --out=$TXNS_DIR/A.txn
goal clerk sign --infile $TXNS_DIR/A.txn --outfile $TXNS_DIR/A.stxn --program $ESCROW_FILE
goal clerk rawsend --filename $TXNS_DIR/A.stxn

